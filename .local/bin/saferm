#!/bin/bash

TRASH_DIR="$HOME/tmp"

print_usage() {
  echo "Usage: saferm [OPTIONS] <file1> [file2 ...]

Safe remove

Options:
  -h, --help                Show this help message and exit."
}

move_to_trash() {
  local file="$1"
  mkdir -p "$TRASH_DIR"

  local base_name
  base_name=$(basename "$file")

  local timestamp
  timestamp=$(date +%s)

  local trash_dir="$TRASH_DIR/$timestamp"
  local new_name="$trash_dir/${base_name}"

  mkdir -p "$trash_dir"
  mv "$file" "$new_name" && echo "'$file' moved to trash as '$new_name'"
}

process_files() {
  local -a files=("${!1}")

  for file in "${files[@]}"; do
    # Skip non-existent files
    if [[ ! -e "$file" ]]; then
      echo "saferm: '$file' does not exist"
      continue
    fi

    move_to_trash "$file"
  done
}

main() {
  local -a files=()

  if [[ $# -eq 0 ]]; then
    print_usage
    exit 1
  fi

  while [[ $# -gt 0 ]]; do
    case "$1" in
    -h | --help)
      print_usage
      exit 0
      ;;
    *)
      files+=("$1")
      shift
      ;;
    esac
  done

  if [[ ${#files[@]} -eq 0 ]]; then
    echo "Error: No files specified."
    print_usage
    exit 1
  fi

  process_files files[@]
}

main "$@"
