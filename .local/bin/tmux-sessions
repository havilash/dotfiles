#!/bin/bash

PATHS=(
  "$HOME/projects/"*
  "$HOME/projects/infravista/"*
  "$HOME/.dotfiles"
  "$HOME/.dotfiles/.config/nvim"
)

TMUX_TEMPLATES_PATH="$HOME/.tmux/templates"

print_usage() {
  echo "Usage: tmux-sessions [OPTIONS] <dir1> [dir2 ...]

Tmux sessions

Options:
  -h, --help                Show this help message and exit."
}

new_session() {
  local name="$1"
  local path="$2"

  local template_file="$TMUX_TEMPLATES_PATH/$name"

  if [[ -f "$template_file" ]]; then
    "$template_file" "$name" "$path"
  else
    cp "$TMUX_TEMPLATES_PATH/default" "$template_file"
    "$template_file" "$name" "$path"
  fi
}

main() {
  local -a dirs=()

  while [[ $# -gt 0 ]]; do
    case "$1" in
    -h | --help)
      print_usage
      exit 0
      ;;
    *)
      dirs+=("$1")
      shift
      ;;
    esac
  done

  if [[ ${#dirs[@]} -eq 0 ]]; then
    dirs=("${PATHS[@]}")
  fi

  local selected
  selected=$(printf "%s\n" "${dirs[@]}" | sed "s|^$HOME|~|" | fzf)
  [[ ! $selected ]] && exit 1

  local selected_name
  selected_name=$(echo "$selected" | sed "s|^~/||" | tr '.' '_')

  if ! tmux has-session -t "$selected_name"; then
    new_session "$selected_name" "${selected//\~/$HOME}"
  fi

  if [[ -n $TMUX ]]; then
    tmux switch-client -t "$selected_name"
  else
    tmux attach-session -t "$selected_name"
  fi
}

main "$@"
